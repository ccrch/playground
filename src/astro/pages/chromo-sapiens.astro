---
export const frontmatter = {
  baseClass: 'chromo-sapiens',
  navDescription: '',
  navTitle: 'Chromo Sapiens',
}

import Layout from '../layouts/playground-layout.astro'
---

<script>
  // import { throttle } from 'throttle-debounce'
  import { lenisScroll } from 'src/scripts/core/helpers'

  lenisScroll.init()

  // const video = document.querySelector<HTMLVideoElement>('.chromo-sapiens video')

  // window.addEventListener('scroll', () => {
  //   if (video) {
  //     const scrollTop = window.scrollY || document.documentElement.scrollTop
  //     const maxScrollTop = document.documentElement.scrollHeight - window.innerHeight
  //     const scrollFraction = scrollTop / maxScrollTop
  //     const frameRate = 60
  //     const frameCount = Math.floor(video.duration * frameRate)
  //     const frameIndex = Math.min(frameCount - 1, Math.floor(scrollFraction * frameCount))

  //     video.currentTime = (frameIndex / frameCount) * video.duration
  //   }
  // })

  const init = () => {
    const video = document.querySelector<HTMLVideoElement>('.chromo-sapiens video')
    if (!video) return

    const onReady = async () => {
      // “Activate” video for iOS seeking
      try {
        await video.play()
        video.pause()
      } catch {}

      let ticking = false
      const update = () => {
        const scrollTop = window.scrollY || document.documentElement.scrollTop
        const maxScrollTop = document.documentElement.scrollHeight - window.innerHeight
        const scrollFraction = maxScrollTop > 0 ? scrollTop / maxScrollTop : 0

        const frameRate = 60
        const frameCount = Math.floor(video.duration * frameRate)
        const frameIndex = Math.min(frameCount - 1, Math.floor(scrollFraction * frameCount))

        video.currentTime = (frameIndex / frameCount) * video.duration
      }

      window.addEventListener(
        'scroll',
        () => {
          if (ticking) return
          ticking = true
          requestAnimationFrame(() => {
            update()
            ticking = false
          })
        },
        { passive: true }
      )

      update()
    }

    if (video.readyState >= 1) onReady()
    else video.addEventListener('loadedmetadata', onReady, { once: true })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true })
  } else {
    init()
  }
</script>

<style lang="scss">
  .chromo-sapiens {
    height: 700vh;

    .video-container {
      position: fixed;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      // inset: 0;
      z-index: 1;
      width: 30vw;
      max-height: 85vh;
      aspect-ratio: 9 / 16;
      background: #111;

      @media (width < 768px) {
        width: 100vw;
        height: 100vh;
        max-height: none;
        aspect-ratio: auto;
      }

      video {
        width: 100%;
        height: 100%;
        // object-fit: contain;
        object-fit: cover;
        // object-position: 50% 75%;
      }
    }
  }
</style>

<Layout baseClass={frontmatter.baseClass} metaDescription={frontmatter.navDescription} metaTitle={frontmatter.navTitle}>
  <main class={frontmatter.baseClass} slot="body">
    <div class="video-container">
      <video autoplay muted playsinline preload="auto">
        <source src="/playground/videos/chromo-sapiens.mp4" type="video/mp4" />
      </video>
    </div>
  </main>
</Layout>
