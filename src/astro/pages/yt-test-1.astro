---
export const frontmatter = {
  baseClass: 'yt-test',
  navDescription: '',
  navTitle: 'YouTube test (1)',
}

import Layout from '../layouts/playground-layout.astro'
---

<script>
  const tag = document.createElement('script')
  tag.src = 'https://www.youtube.com/iframe_api'
  const firstScriptTag = document.getElementsByTagName('script')[0]
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)

  declare const YT: any

  const el = {
    currentTime: document.querySelector<HTMLElement>('.youtube .controls p span'),
    loadButton: document.querySelector<HTMLElement>('.youtube .controls button:nth-child(1)'),
    pauseButton: document.querySelector<HTMLElement>('.youtube .controls button:nth-child(3)'),
    playButton: document.querySelector<HTMLElement>('.youtube .controls button:nth-child(2)'),
    player: document.querySelector<HTMLElement>('.youtube .player'),
    playerIframe: document.querySelector<HTMLElement>('.youtube .player > div'),
  }

  let interval = null
  let ytPlayer: YT.Player = null

  // https://developers.google.com/youtube/iframe_api_reference
  ;(window as any).onYouTubeIframeAPIReady = () => {
    ytPlayer = new YT.Player(el.playerIframe, {
      height: '100%',
      width: '100%',
      // videoId: 'YDptAmbmUHE',
      playerVars: {
        // autoplay: 1,
        controls: 0,
        fs: 0,
        iv_load_policy: 3,
        // loop: 1,
        modestbranding: 1,
        mute: 0,
        // playlist:'YDptAmbmUHE',
        playsinline: 1,
        rel: 0,
      },
      // events: {
      //   onReady: onPlayerReady,
      //   onStateChange: onPlayerStateChange
      // }
    })
  }

  const runTimer = () => {
    const updateTime = () => {
      el.currentTime.textContent = `${ytPlayer.getCurrentTime().toFixed(1)}s`

      if (ytPlayer.getPlayerState() === 0) {
        ytPlayer.seekTo(8, true)
      }
    }

    interval = setInterval(updateTime, 123)
  }

  el.loadButton.addEventListener('click', () => {
    if (!ytPlayer) return

    ytPlayer.loadVideoById({
      videoId: 'YDptAmbmUHE',
      startSeconds: 8,
      endSeconds: 20.65,
    })

    if (interval) {
      clearInterval(interval)
    }

    runTimer()

    el.player.classList.remove('player--paused')
  })

  setTimeout(() => {
    el.loadButton.click()
  }, 1234)

  el.playButton.addEventListener('click', () => {
    if (!ytPlayer) return
    if (!ytPlayer.getVideoData().video_id) return

    ytPlayer.playVideo()
    el.player.classList.remove('player--paused')
  })

  el.pauseButton.addEventListener('click', () => {
    if (!ytPlayer) return
    if (!ytPlayer.getVideoData().video_id) return

    ytPlayer.pauseVideo()
    el.player.classList.add('player--paused')
  })
</script>

<style lang="scss">
  .youtube {
    display: flex;
    flex-flow: row wrap;
    align-items: center;
    justify-content: flex-start;
    gap: 1.5vw;
    padding: 20vh 20vw;

    .player {
      position: relative;
      z-index: 1;
      width: 60vw;
      overflow: hidden;
      aspect-ratio: 16 / 9;
      background: #111;

      &::before {
        content: '';
        position: absolute;
        inset: 0;
        z-index: 2;
        background: #111;
        opacity: 0;
        pointer-events: none;
        // transition: opacity 0.321s ease-in-out;
      }

      &--paused::before {
        opacity: 0.7;
      }

      iframe {
        // position: absolute;
        // inset: -50px;
        // z-index: 1;
        // max-width: none !important;
        // width: calc(100% + 100px) !important;
        // height: calc(100% + 100px) !important;
        width: 100%;
        height: 100%;
        border: none;
      }
    }
  }
</style>

<Layout baseClass={frontmatter.baseClass} metaDescription={frontmatter.navDescription} metaTitle={frontmatter.navTitle}>
  <main class={frontmatter.baseClass} slot="body">
    <div class="youtube">
      <div class="player player--paused">
        <div></div>
      </div>
      <div class="controls">
        <button>load</button>
        <button>play</button>
        <button>pause</button>
        <p>Current time: <span>0</span></p>
      </div>
    </div>
  </main>
</Layout>
